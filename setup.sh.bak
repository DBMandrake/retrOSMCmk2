#!/bin/bash

# check we are running as root for all of the install work
if [ "$EUID" -ne 0 ]; then
    echo -e "\n***\nPlease run as sudo.\nThis is needed for installing any dependancies as we go and for running RetroPie-Setup.\n***"
    exit
fi

# all operations performed relative to script directory
pushd $(dirname "${BASH_SOURCE[0]}") >/dev/null

# load variables and functions
. ./resources/data.sh
. ./resources/functions.sh

# RetroPie-Setup will - post update - call this script specifically to restore the lost patches
if [[ "$1" == "PATCH" ]]; then
    patchRetroPie
    popd >/dev/null
    return 0
fi

# perform initial setup if this is the 1st run
if [[ first_run -eq 1 ]]; then
    firstTimeSetup
fi

# RetroPie is not yet patched at fresh install, nor if something wen t wrong after an update
if [[ patched_version -ne $(git -C RetroPie-Setup/ log -1 --pretty=format:"%h") ]]; then
    patchRetroPie
fi

# dialog menu here
    while true; do
        exec 3>&1
        selection=$(dialog \
            --backtitle "Hyperion$tag Setup on Vero4K" \
            --title "Hyperion$tag" \
            --clear \
            --cancel-label "Back" \
            --item-help \
            --menu "Please select:" 0 0 4 \
            "1" "Install from binary" "Install from binary" \
            "2" "Build from source" "Build from source" \
            "3" "Uninstall" "Uninstall" \
            "4" "Post Installation" "Post Installation" \
            2>&1 1>&3)
        ret_val=$?
        exec 3>&-

        case $ret_val in
            $DIALOG_CANCEL)
                clear
                break
                ;;
            $DIALOG_ESC)
                clear
                break
                ;;
        esac

        case $selection in
            0 )
                clear
                echo "Program terminated @004." #004
                ;;
            1 )
                dialog --backtitle "Hyperion$tag Setup on Vero4K - Install from binary" --title "Advice" --msgbox \
"This will install a prebuilt version of Hyperion$tag with all of the Vero4K compatible compilation options enabled.\n
\n
Of course this will use a little more file space and possibly more CPU resources, for features you may not need.\n
\n\
It will also be an older version, so consider building from source once you've tried things out." 0 0

                if (dialog --backtitle "Hyperion$tag Setup on Vero4K - Install from binary" --title "PROCEED?" --defaultno --no-label "Abort" --yesno "This will delete any previous build files and folders you may have.\n\nIt will attempt to preserve old configs..." 0 0); then
                    cd $REPO_DIR/hyperion_$edition/prebuilt_$edition
                    install_relative
                fi
                ;;
            2 )
                dialog --backtitle "Hyperion$tag Setup on Vero4K - Build from source" --title "Advice" --msgbox "$build_advice" 0 0
                cd $REPO_DIR/hyperion_$edition
                build_from_source
                ;;
            3 )
                uninstall
                ;;
            4 )
                post_installation
                ;;
        esac
    done


# the end - get back to whence we came
popd >/dev/null
return 0
